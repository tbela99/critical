var umd=function(e){"use strict";function t(e,t){if(e.match(/^['"]?data:/))return e;const r=new URL(t,window.location),n=new URL(e,r);return r.protocol!=n.protocol||r.host!=n.host||n.host!=window.location.host||r.port!=n.port||n.port!=window.location.port||r.port!=n.port||n.protocol!=window.location.protocol?n.toString():n.pathname+n.search+n.hash}function r(e){return"/* font preloader script: "+e.length+' */\n"fonts" in document && '+JSON.stringify([...e],null,1)+".forEach(font => new FontFace(font.fontFamily, font.src, font.properties).load().then(font => document.fonts.add(font)))"}function n(){throw new Error("CSS extraction aborted")}async function a(e){const a=window.document,o=window.location,l=new Set,s=["all","print",""],i=new Array,c=window.innerHeight,f=a.createNodeIterator(a,NodeFilter.SHOW_ELEMENT,{acceptNode:()=>NodeFilter.SHOW_ELEMENT}),u=new Set,p=new Set,h=new Map,m=new WeakMap,d=new WeakMap;let y,S,g,w,x,b=0;for(e.signal?.addEventListener("abort",n),performance.mark("filterStylesheets"),y=0;y<a.styleSheets.length;y++)if(S=a.styleSheets[y],"print"!==S.media.mediaText&&(""===S.media.mediaText||window.matchMedia(S.media.mediaText).matches))try{g=S.cssRules||S.rules;for(let e=0;e<g.length;e++)i.push({rule:g[e],match:!1})}catch(e){console.error(JSON.stringify({message:e.message+"\n"+e.stack,stylesheet:S.href},null,1))}if(performance.measure("filter stylesheets","filterStylesheets"),0===i.length)return{styles:[],fonts:[],stats:{}};let E,C=i.length;for(performance.mark("nodeWalking");w=f.nextNode();){if(e&&e.signal&&e.signal.aborted)return Promise.reject("Aborted");["SCRIPT","LINK","HEAD","META","TITLE","NOSCRIPT"].includes(w.tagName)||(b++,x=w.getBoundingClientRect(),x.top<c&&d.set(w,1))}for(y=0;y<C;y++)if(!i[y].match&&!m.has(i[y].rule))if(m.set(i[y].rule,1),i[y].rule instanceof CSSStyleRule){let e,t=i[y].rule.selectorText;if(t.match(/(^|,|\s)::?((before)|(after))/))e=!0;else{t.match(/::?((before)|(after))/)&&(t=t.replace(/::?((before)|(after))\s*((,)|$)/g,"$5"));try{e=d.has(a.querySelector(t))}catch(t){e=d.has(a.querySelector(i[y].rule.selectorText))}}e&&(i[y].match=!0,i[y].rule.style.getPropertyValue("font-family")&&i[y].rule.style.getPropertyValue("font-family").split(/\s*,\s*/).forEach((e=>"inherit"!==e&&p.add(e.replace(/(['"])([^\1\s]+)\1/,"$2")))))}else if(i[y].rule instanceof CSSMediaRule||i[y].rule instanceof CSSImportRule||i[y].rule instanceof CSSConditionRule){if((i[y].rule instanceof CSSMediaRule||i[y].rule instanceof CSSImportRule)&&("print"===i[y].rule.media.mediaText||""!==i[y].rule.media.mediaText&&!window.matchMedia(i[y].rule.media.mediaText).matches))continue;try{const e=i[y].rule,t=[],r=e instanceof CSSImportRule?e.styleSheet.cssRules||e.styleSheet.rules:e.cssRules||e.rules;for(let e=0;e<r.length;e++)m.has(r[e])||t.push({rule:r[e],match:!1});t.length>0&&(i.splice.apply(i,[y+1,0].concat(t)),C=i.length)}catch(e){console.error(JSON.stringify({message:e.message+"\n"+e.stack,stylesheet:S.href},null,1))}}else i[y].rule instanceof CSSFontFaceRule&&i[y].rule.style.getPropertyValue("font-family")&&i[y].rule.style.getPropertyValue("src")&&u.add(i[y].rule);performance.measure("node walking","nodeWalking");let R="",T=-1;performance.mark("rulesExtraction");e:for(let e=0;e<C;e++){if(!i[e].match)continue;S=i[e].rule;let r=!1;if(h.has(S.parentStyleSheet)?R&&R!==h.get(S.parentStyleSheet).file&&(r=!0):(h.set(S.parentStyleSheet,{base:(S.parentStyleSheet.href&&S.parentStyleSheet.href.replace(/[?#].*/,"")||o.pathname).replace(/([^/]+)$/,""),file:S.parentStyleSheet.href||"inline style #"+ ++T}),r=!0),r)try{console.log("analysing "+h.get(S.parentStyleSheet).file),l.add("/* file: "+h.get(S.parentStyleSheet).file+" */")}catch(e){console.error(JSON.stringify(e.message+"\n"+e.stack,null,1)),console.error(JSON.stringify(S?.parentStyleSheet?.href,null,1))}for(R=h.get(S.parentStyleSheet).file,E=S.cssText,"inline"!==R&&(E=E.replace(/url\(([^)%\s]*?)\)/g,(function(e,r){return(r=r.trim()).match(/^['"]?data:/)?e:"url("+t(r=r.replace(/^(['"])([^\1\s]+)\1/,"$2"),h.get(S.parentStyleSheet).base)+")"})));S.parentRule;){if(S=S.parentRule,"print"==S.conditionText)continue e;if(s.includes(S.conditionText)||(E="@"+S.constructor.name.replace(/^CSS(.*?)Rule/,"$1").toLowerCase()+" "+S.conditionText+" {"+E+"}"),!S.parentRule)break}if(S.parentStyleSheet){let e=S.parentStyleSheet.media.mediaText;if("print"===e)continue;""!==e&&(E="@media "+e+" {"+E+"}")}l.has(E)&&l.delete(E),l.add(E)}performance.measure("rules extraction","rulesExtraction");const N=new Map;if(e.fonts){let e,r,n,a,o,l;for(a of(performance.mark("fontsExtraction"),u))if(a.style.getPropertyValue("font-family").split(/\s*,\s*/).some((e=>p.has(e.replace(/(['"])([^\1\s]+)\1/,"$2"))))){if(l=a.style.getPropertyValue("src"),!l)continue;for(o={fontFamily:a.style.getPropertyValue("font-family").replace(/(['"])([^\1\s]+)\1/,"$2"),src:l.replace(/(^|[,\s*])local\([^)]+\)\s*,?\s*?/g,"").replace(/url\(([^)%\s]+)\)([^,]*)(,?)\s*/g,((e,r,n,o)=>{if(r=r.replace(/(['"])([^\1\s]+)\1/,"$2"),!h.has(a.parentStyleSheet)){if(!a.parentStyleSheet.href)return e;h.set(a.parentStyleSheet,{base:a.parentStyleSheet.href.replace(/([^/]+)$/,""),file:a.parentStyleSheet.href})}return"url("+t(r,h.get(a.parentStyleSheet).base)+")"+o})).trim(),properties:{}},e=a.style.length;e--;)r=a.style.item(e),n=a.style.getPropertyValue(r),"font-family"!==r&&"src"!==r&&""!==n&&void 0!==n&&(o.properties[r.replace(/([A-Z])/g,((e,t)=>"-"+t.toLowerCase()))]=n);N.set(JSON.stringify(o),o)}performance.measure("fonts extraction","fontsExtraction")}const k=performance.getEntriesByType("measure").filter((e=>["filter stylesheets","node walking","rules extraction","fonts extraction"].includes(e.name))).map((e=>({name:e.name,duration:(e.duration/1e3).toFixed(3)+"s"}))),L={styles:[...l],fonts:[...N.values()],nodeCount:b,stats:{nodeCount:b,stats:k}};if(e.html){if(!a.querySelector("base")){const e=a.createElement("base");e.href=o.protocol+"//"+o.host+o.pathname,a.head.insertBefore(e,a.querySelector("meta[charset]")?.nextElementSibling||a.head.firstChild)}if(!a.querySelector("meta[charset]")){const e=a.createElement("meta");e.setAttribute("charset","utf-8"),a.head.insertBefore(e,a.head.firstChild)}Array.from(a.querySelectorAll("style,link[rel=stylesheet]")).forEach((e=>{if(a.body.append(e),"LINK"===e.tagName){if("print"===e.media)return;e.hasAttribute("media")&&e.setAttribute("data-media",e.media),e.media="print",e.dataset.async=""}}));const t=a.createElement("style");t.dataset.critical=!0;const l=[...N.values()].map((e=>"@font-face {\n "+Object.entries(e).map((e=>"string"==typeof e[1]?""+(e[0]+": "+e[1]):Object.entries(e[1]).map((e=>""+(e[0]+": "+e[1]))).join(";\n ")+"\n}")).join(";\n"))).join("\n")+"\n"+L.styles.join("\n");if(null!=e.transform?await e.transform(l).then((e=>t.textContent=e.code)):t.textContent=l,""!==t.innerText.trim()&&a.head.insertBefore(t,a.querySelector("base")?.nextElementSibling),L.fonts.length>0){const e=a.createElement("script");e.textContent=r(L.fonts),a.head.append(e)}e?.signal?.removeEventListener("abort",n);const s=a.doctype;L.html=(s?`<!Doctype ${s.name}`+(s.publicId?` PUBLIC "${s.publicId}"`:"")+(s.systemId?(s.publicId?"":" SYSTEM")+` "${s.systemId}"`:"")+">\n":"")+a.documentElement.outerHTML}return L}async function o(e,t,r="application/octet-stream; charset=utf-8"){const n=URL.createObjectURL(new Blob(e,{type:r})),a=document.createElement("a");return document.body.append(a),a.style.display="none",a.download=t,a.href=n,a.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL(n),e}return e.download=async function(e="critical.css",t={}){return a(t).then((async t=>o(t.styles,e,"text/css; charset=utf-8").then((async()=>{if(t.fonts.length>0)return o([r(t.fonts)],e.replace(/\.css$/,".js"),"text/javascript; charset=utf-8")})).then((()=>t))))},e.extract=a,e.fontscript=r,e}({});
